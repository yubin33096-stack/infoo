import streamlit as st
import google.generativeai as genai
from datetime import datetime
import csv
import io
import time

# ----------------------------
# ì´ˆê¸° ì„¤ì •
# ----------------------------
st.set_page_config(page_title="AI ì›¨ì´íŒ… ì•Œë¦¼ ì±—ë´‡", layout="wide")
st.title("ğŸ½ï¸ AI ì›¨ì´íŒ… ì•Œë¦¼ ì±—ë´‡ (Gemini API + Streamlit)")

# Gemini API Key
if "GEMINI_API_KEY" not in st.secrets:
    api_key = st.text_input("Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”:", type="password")
else:
    api_key = st.secrets["GEMINI_API_KEY"]

if api_key:
    genai.configure(api_key=api_key)

# ëª¨ë¸ ì„ íƒ
model_list = ["gemini-2.0-flash", "gemini-1.5-flash", "gemini-1.5-pro"]
model = st.selectbox("ëª¨ë¸ ì„ íƒ", model_list)

# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ì‹ë‹¹ ì›¨ì´íŒ… ì•ˆë‚´ë¥¼ ë„ì™€ì£¼ëŠ” 'ì¹œì ˆí•œ ìƒë‹´ ì±—ë´‡'ì…ë‹ˆë‹¤.

ê·œì¹™:
1) ì‚¬ìš©ìëŠ” ì‹ë‹¹ì„ ì°¾ëŠ” ê³¼ì •ì—ì„œ ì–¼ë§ˆë‚˜ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ”ì§€ ë¶ˆí¸í•¨ì„ í‘œí˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
   â†’ ì •ì¤‘í•˜ê³  ê³µê° ì–´ë¦° ë§íˆ¬ë¡œ ì‘ëŒ€í•˜ì„¸ìš”.

2) ì‚¬ìš©ìì˜ ë¶ˆí¸ ì‚¬í•­ì„ (ë¬´ì—‡ì´/ì–¸ì œ/ì–´ë””ì„œ/ì–´ë–»ê²Œ) í˜•íƒœë¡œ ì •ë¦¬í•˜ì—¬ ìˆ˜ì§‘í•˜ê³   
   â†’ â€œê³§ í™•ì¸í•˜ì—¬ ì•ˆë‚´ë“œë¦°ë‹¤â€ëŠ” ì·¨ì§€ë¡œ ë‹µë³€í•˜ì„¸ìš”.

3) ë§ˆì§€ë§‰ ë¬¸ì¥ì€ ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
   - ê¸°ë³¸: â€œí™•ì¸ í›„ íšŒì‹ ì„ ìœ„í•´ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì•Œë ¤ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?â€
   - ì‚¬ìš©ìê°€ ì´ë©”ì¼ ì œê³µì„ ê±°ë¶€í•˜ë©´:  
     â€œì£„ì†¡í•˜ì§€ë§Œ, ì—°ë½ì²˜ ì •ë³´ë¥¼ ë°›ì§€ ëª»í•˜ì—¬ ì›¨ì´íŒ… ë‚´ìš©ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ì—†ì–´ìš”.â€

4) ì ˆëŒ€ ê³µê²©ì , ë¬´ë¡€í•œ í‘œí˜„ ì‚¬ìš© ê¸ˆì§€.
"""

# ì„¸ì…˜ ì´ˆê¸°í™”
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]

if "log" not in st.session_state:
    st.session_state.log = []

# CSV ì˜µì…˜
save_csv = st.checkbox("ëŒ€í™”ë¥¼ CSVë¡œ ìë™ ì €ì¥")


# -----------------------------------------
# í•¨ìˆ˜: Gemini Call with Retry + 429í•¸ë“¤ë§
# -----------------------------------------
def call_gemini_with_retry(prompt, retries=3, delay=2):
    for attempt in range(retries):
        try:
            client = genai.GenerativeModel(model)
            response = client.generate_content(prompt)
            return response.text
        except Exception as e:
            if "429" in str(e):
                time.sleep(delay)
                continue
            return f"âš ï¸ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
    return "âš ï¸ ì—°ì†ëœ 429 ì˜¤ë¥˜ë¡œ ìƒˆ ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”."


# -----------------------------------------
# UI - ëŒ€í™” ì¶œë ¥
# -----------------------------------------
st.subheader("ğŸ’¬ ëŒ€í™”")

for msg in st.session_state.messages[1:]:
    if msg["role"] == "user":
        st.chat_message("user").write(msg["content"])
    else:
        st.chat_message("assistant").write(msg["content"])


# -----------------------------------------
# ì…ë ¥ì°½
# -----------------------------------------
user_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...")

if user_input:
    st.session_state.messages.append({"role": "user", "content": user_input})
    st.chat_message("user").write(user_input)

    # ìµœê·¼ 6í„´ë§Œ ìœ ì§€
    recent_context = st.session_state.messages[-6:]
    merged = "\n".join([f"{m['role']}: {m['content']}" for m in recent_context])

    # Gemini API í˜¸ì¶œ
    assistant_reply = call_gemini_with_retry(merged)

    # 429 ì¬ì‹œì‘ ë©”ì‹œì§€ë©´ ì„¸ì…˜ ë¦¬ì…‹
    if "429 ì˜¤ë¥˜" in assistant_reply:
        st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    else:
        st.session_state.messages.append({"role": "assistant", "content": assistant_reply})
        st.chat_message("assistant").write(assistant_reply)

    # ë¡œê·¸ ì €ì¥
    st.session_state.log.append({
        "timestamp": datetime.now().isoformat(),
        "user": user_input,
        "assistant": assistant_reply
    })

    # CSV ìë™ ì €ì¥
    if save_csv:
        with open("chat_log.csv", "a", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow([datetime.now().isoformat(), user_input, assistant_reply])


# -----------------------------------------
# ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
# -----------------------------------------
st.subheader("ğŸ“¥ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ")
if st.button("CSV ë‹¤ìš´ë¡œë“œ"):
    csv_buffer = io.StringIO()
    writer = csv.writer(csv_buffer)
    writer.writerow(["timestamp", "user", "assistant"])
    for row in st.session_state.log:
        writer.writerow([row["timestamp"], row["user"], row["assistant"]])

    st.download_button(
        label="chat_log.csv ë‹¤ìš´ë¡œë“œ",
        data=csv_buffer.getvalue(),
        file_name="chat_log.csv",
        mime="text/csv"
    )


# -----------------------------------------
# ëŒ€í™” ì´ˆê¸°í™” ë²„íŠ¼
# -----------------------------------------
if st.button("ğŸ”„ ëŒ€í™” ì´ˆê¸°í™”"):
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    st.session_state.log = []
    st.rerun()


# -----------------------------------------
# ëª¨ë¸/ì„¸ì…˜ í‘œì‹œ
# -----------------------------------------
st.markdown(f"---\n**í˜„ì¬ ëª¨ë¸:** `{model}`  
**ì„¸ì…˜ ë©”ì‹œì§€ ìˆ˜:** {len(st.session_state.messages) - 1}í„´")